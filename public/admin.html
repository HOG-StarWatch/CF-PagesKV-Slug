<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudLink ç®¡ç†é¢æ¿</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”—</text></svg>">
    <style>
        :root {
            --bg: #f4f6fb;
            --bg-dark: #0f172a;
            --surface: rgba(255, 255, 255, 0.92);
            --surface-dark: rgba(15, 23, 42, 0.85);
            --border: rgba(15, 23, 42, 0.08);
            --border-dark: rgba(148, 163, 184, 0.25);
            --text: #0f172a;
            --text-muted: #475569;
            --text-dark: #e2e8f0;
            --text-muted-dark: #94a3b8;
            --primary: #6366f1;
            --primary-dark: #a5b4fc;
            --danger: #ef4444;
            --radius: 16px;
            --shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #020617;
                --surface: var(--surface-dark);
                --border: var(--border-dark);
                --text: var(--text-dark);
                --text-muted: var(--text-muted-dark);
                --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', 'HarmonyOS Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at top, rgba(99, 102, 241, 0.25), transparent 45%),
                        radial-gradient(circle at 20% 20%, rgba(236, 72, 153, 0.18), transparent 40%),
                        var(--bg);
            color: var(--text);
            padding: clamp(1rem, 2vw, 3rem);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-shell {
            width: min(1100px, 100%);
        }

        .panel {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: clamp(1.5rem, 3vw, 3rem);
        }

        .auth-panel {
            max-width: 420px;
            margin: 0 auto;
            text-align: center;
        }

        .auth-panel h1 {
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }

        .auth-panel p {
            margin-top: 0;
            color: var(--text-muted);
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        input[type="password"],
        input[type="text"] {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0.95rem 1.1rem;
            font-size: 1rem;
            background: rgba(99, 102, 241, 0.04);
            transition: border 0.2s ease, box-shadow 0.2s ease;
            color: var(--text);
        }

        input[type="password"]:focus,
        input[type="text"]:focus {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
            outline: none;
            background: rgba(255, 255, 255, 0.35);
        }

        .btn-primary,
        .btn-outline,
        .btn-danger,
        .btn-ghost {
            border: none;
            border-radius: 999px;
            padding: 0.7rem 1.4rem;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
        }

        .btn-primary {
            background: linear-gradient(120deg, #6366f1, #a855f7);
            color: #fff;
            width: 100%;
            margin-top: 1.2rem;
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.35);
        }

        .btn-outline {
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.08);
            color: #ef4444;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-muted);
            padding: 0.4rem 0.8rem;
            border-radius: 10px;
        }

        .btn-primary:hover,
        .btn-outline:hover,
        .btn-danger:hover,
        .btn-ghost:hover {
            transform: translateY(-1px);
        }

        .dashboard__header {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            align-items: flex-start;
            justify-content: space-between;
        }

        .eyebrow {
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .dashboard__header h1 {
            margin: 0.35rem 0 0.5rem;
            font-size: clamp(1.8rem, 3vw, 2.4rem);
        }

        .dashboard__header p {
            margin: 0;
            color: var(--text-muted);
            max-width: 540px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            padding: 1.2rem 1.4rem;
            border: 1px solid var(--border);
            border-radius: 18px;
            background: rgba(99, 102, 241, 0.04);
        }

        .stat-card h2 {
            margin: 0.35rem 0;
            font-size: 2.1rem;
        }

        .stat-card span {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .search-wrap {
            flex: 1 1 260px;
            position: relative;
        }

        .search-wrap button {
            position: absolute;
            right: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.2rem;
            display: none;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }

        .filter-pills button {
            border-radius: 999px;
            border: 1px solid transparent;
            background: rgba(99, 102, 241, 0.08);
            color: var(--text);
            padding: 0.45rem 1rem;
            font-size: 0.85rem;
        }

        .filter-pills button.active {
            background: rgba(99, 102, 241, 0.18);
            border-color: rgba(99, 102, 241, 0.4);
            color: var(--primary);
        }

        .control-actions {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .selection-hint {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 14px;
            padding: 0.6rem 1rem;
            background: rgba(16, 185, 129, 0.12);
            color: #047857;
            font-weight: 500;
        }

        .table-wrapper {
            position: relative;
            border: 1px solid var(--border);
            border-radius: 18px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 760px;
        }

        thead {
            background: rgba(99, 102, 241, 0.06);
        }

        th, td {
            padding: 1rem 1.3rem;
            text-align: left;
            border-bottom: 1px solid rgba(15, 23, 42, 0.05);
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .checkbox-cell {
            width: 48px;
        }

        .slug-link {
            font-weight: 600;
            color: var(--primary);
            text-decoration: none;
        }

        .slug-meta {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .url-cell {
            max-width: 280px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-muted);
        }

        .badge {
            padding: 0.15rem 0.65rem;
            border-radius: 999px;
            font-size: 0.78rem;
        }

        .badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: #047857;
        }

        .badge.protected {
            background: rgba(59, 130, 246, 0.15);
            color: #1d4ed8;
        }

        .badge.expired {
            background: rgba(239, 68, 68, 0.15);
            color: #b91c1c;
        }

        .empty-state,
        .loading-state {
            position: absolute;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 0.6rem;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(4px);
        }

        .empty-state p,
        .loading-state p {
            margin: 0;
            color: var(--text-muted);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid rgba(99, 102, 241, 0.25);
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: #22c55e;
            color: #fff;
            padding: 0.8rem 1.6rem;
            border-radius: 999px;
            font-size: 0.9rem;
            box-shadow: 0 10px 25px rgba(34, 197, 94, 0.35);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .toast.error {
            background: #ef4444;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.35);
        }

        @media (max-width: 720px) {
            body {
                padding: 1rem;
            }
            .table-wrapper {
                overflow-x: auto;
            }
            table {
                min-width: 640px;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <section id="login" class="panel auth-panel">
            <p class="eyebrow">CloudLink Â· Admin</p>
            <h1>ç™»å½•æ§åˆ¶ä¸­æ¢</h1>
            <p>è¾“å…¥ç®¡ç†å‘˜å¯†é’¥ä»¥ç®¡ç†æ‰€æœ‰çŸ­é“¾ä¸å®‰å…¨ç­–ç•¥ã€‚</p>
            <input type="password" id="adminKey" placeholder="Admin Key" onkeyup="if(event.key==='Enter') login()">
            <button class="btn-primary" onclick="login()">ç«‹å³ç™»å½•</button>
        </section>

        <section id="panel" class="panel dashboard" style="display: none;">
            <header class="dashboard__header">
                <div>
                    <p class="eyebrow">CloudLink / Realtime Ops</p>
                    <h1>çŸ­é“¾è¿è¥é¢æ¿</h1>
                    <p>å®æ—¶æŸ¥çœ‹çŸ­é“¾çŠ¶æ€ã€ç­›é€‰æ•æ„Ÿé“¾æ¥å¹¶é€šè¿‡ç®¡ç†å‘˜å¯†é’¥æ‰§è¡Œæ‰¹é‡æ“ä½œã€‚</p>
                </div>
                <div class="control-actions">
                    <button class="btn-outline" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </header>

            <section class="stats-grid">
                <article class="stat-card">
                    <p class="eyebrow">æ€»é‡</p>
                    <h2 id="statTotal">0</h2>
                    <span>å…¨éƒ¨çŸ­é“¾</span>
                </article>
                <article class="stat-card">
                    <p class="eyebrow">æ´»è·ƒ</p>
                    <h2 id="statActive">0</h2>
                    <span>å°šåœ¨æœ‰æ•ˆæœŸå†…</span>
                </article>
                <article class="stat-card">
                    <p class="eyebrow">å¯†ç ä¿æŠ¤</p>
                    <h2 id="statProtected">0</h2>
                    <span>å·²å¯ç”¨è®¿é—®å¯†ç </span>
                </article>
                <article class="stat-card">
                    <p class="eyebrow">å·²è¿‡æœŸ</p>
                    <h2 id="statExpired">0</h2>
                    <span>éœ€æ¸…ç†çš„é“¾æ¥</span>
                </article>
            </section>

            <section class="control-panel">
                <div class="search-wrap">
                    <input type="text" id="searchInput" placeholder="æœç´¢ slugã€åŸå§‹é“¾æ¥æˆ–å…³é”®å­—">
                    <button type="button" id="clearSearch" aria-label="æ¸…ç©ºæœç´¢" onclick="clearSearch()">âœ•</button>
                </div>
                <div class="filter-pills" id="filterPills">
                    <button type="button" class="active" data-filter="all">å…¨éƒ¨</button>
                    <button type="button" data-filter="active">æ´»è·ƒ</button>
                    <button type="button" data-filter="protected">å¯†ç ä¿æŠ¤</button>
                    <button type="button" data-filter="expired">å·²è¿‡æœŸ</button>
                </div>
                <div class="control-actions">
                    <button class="btn-outline" onclick="loadLinks()">åˆ·æ–°</button>
                    <button class="btn-danger" id="batchDeleteBtn" onclick="deleteSelected()" disabled>åˆ é™¤å·²é€‰</button>
                </div>
            </section>

            <div id="selectionHint" class="selection-hint" style="display: none;">
                å·²é€‰ä¸­ <strong id="selectedCount">0</strong> æ¡çŸ­é“¾
            </div>

            <div class="table-wrapper">
                <table id="linksTable">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th>çŸ­é“¾</th>
                            <th>åŸå§‹é“¾æ¥</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="linksBody"></tbody>
                </table>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>æš‚æ— ç¬¦åˆæ¡ä»¶çš„çŸ­é“¾</p>
                </div>
                <div id="loading" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ•°æ®åŒæ­¥ä¸­...</p>
                </div>
            </div>
        </section>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
        const API_BASE = '/api';
        const state = {
            links: [],
            filtered: [],
            filter: 'all',
            query: '',
            selection: new Set()
        };

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type === 'error' ? ' error' : '');
            setTimeout(() => toast.className = 'toast', 2600);
        }

        function login() {
            const key = document.getElementById('adminKey').value.trim();
            if (!key) return;
            localStorage.setItem('adminKey', key);
            checkAuth();
        }

        function logout() {
            localStorage.removeItem('adminKey');
            state.selection.clear();
            document.getElementById('panel').style.display = 'none';
            document.getElementById('login').style.display = 'block';
        }

        function checkAuth() {
            const key = localStorage.getItem('adminKey');
            if (!key) return;
            document.getElementById('login').style.display = 'none';
            document.getElementById('panel').style.display = 'flex';
            loadLinks();
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatDate(timestamp) {
            const value = Number(timestamp);
            if (!Number.isFinite(value) || value <= 0) return '-';
            try {
                return new Date(value).toLocaleString();
            } catch {
                return '-';
            }
        }

        function isExpired(link) {
            if (!link || link.expiration === undefined || link.expiration === null) return false;
            const exp = Number(link.expiration);
            if (!Number.isFinite(exp)) return false;
            return exp < Date.now() / 1000;
        }

        function getStatus(link) {
            if (isExpired(link)) return 'expired';
            if (link.hasPassword) return 'protected';
            return 'active';
        }

        async function loadLinks() {
            const key = localStorage.getItem('adminKey');
            if (!key) {
                logout();
                return;
            }

            toggleLoading(true);
            try {
                const res = await fetch(`${API_BASE}/list`, {
                    headers: { 'X-Admin-Key': key }
                });

                if (res.status === 401) {
                    showToast('Admin Key æ— æ•ˆ', 'error');
                    setTimeout(logout, 1500);
                    return;
                }

                const data = await res.json();
                state.links = (data.links || []).sort((a, b) => (b.created || 0) - (a.created || 0));
                state.selection.clear();
                applyFilters();
            } catch (err) {
                showToast('åŠ è½½å¤±è´¥: ' + err.message, 'error');
            } finally {
                toggleLoading(false);
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function applyFilters() {
            pruneSelection();
            const query = state.query.toLowerCase();
            const filtered = state.links.filter(link => {
                const status = getStatus(link);
                if (state.filter !== 'all' && status !== state.filter) return false;
                if (!query) return true;
                const slugHit = (link.slug || '').toLowerCase().includes(query);
                const urlHit = (link.url || '').toLowerCase().includes(query);
                return slugHit || urlHit;
            });

            state.filtered = filtered;
            renderTable();
            updateStats();
            updateSelectionControls();
        }

        function pruneSelection() {
            const valid = new Set(state.links.map(l => l.slug));
            state.selection.forEach(slug => {
                if (!valid.has(slug)) {
                    state.selection.delete(slug);
                }
            });
        }

        function statusBadge(link) {
            const status = getStatus(link);
            const labelMap = {
                active: 'æ´»è·ƒ',
                protected: 'å¯†ç ä¿æŠ¤',
                expired: 'å·²è¿‡æœŸ'
            };
            return `<span class="badge ${status}">${labelMap[status]}</span>`;
        }

        function renderTable() {
            const tbody = document.getElementById('linksBody');
            const emptyState = document.getElementById('emptyState');

            if (state.filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'flex';
                syncSelectAllIndicator();
                return;
            }

            emptyState.style.display = 'none';

            tbody.innerHTML = state.filtered.map(link => {
                const safeSlug = escapeHtml(link.slug);
                const safeUrl = escapeHtml(link.url);
                const created = link.created ? formatDate(link.created) : '-';
                const checked = state.selection.has(link.slug) ? 'checked' : '';
                return `
                    <tr>
                        <td class="checkbox-cell">
                            <input type="checkbox" class="row-checkbox" data-slug="${safeSlug}" ${checked}>
                        </td>
                        <td>
                            <div>
                                <a class="slug-link" href="/${safeSlug}" target="_blank">/${safeSlug}</a>
                                <div class="slug-meta">${link.expiration ? 'åˆ°æœŸï¼š' + formatDate(link.expiration * 1000) : 'é•¿æœŸæœ‰æ•ˆ'}</div>
                            </div>
                        </td>
                        <td class="url-cell" title="${safeUrl}">${safeUrl}</td>
                        <td>${created}</td>
                        <td>${statusBadge(link)}</td>
                        <td>
                            <button class="btn-ghost delete-link" data-slug="${safeSlug}">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
            }).join('');

            syncSelectAllIndicator();
        }

        function updateStats() {
            const total = state.links.length;
            const expired = state.links.filter(isExpired).length;
            const protectedCount = state.links.filter(link => link.hasPassword).length;
            const active = total - expired;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statExpired').textContent = expired;
            document.getElementById('statProtected').textContent = protectedCount;
            document.getElementById('statActive').textContent = active < 0 ? 0 : active;
        }

        function updateSelectionControls() {
            const count = state.selection.size;
            const hint = document.getElementById('selectionHint');
            const countLabel = document.getElementById('selectedCount');
            const btn = document.getElementById('batchDeleteBtn');

            if (count > 0) {
                hint.style.display = 'inline-flex';
                countLabel.textContent = count;
                btn.disabled = false;
                btn.textContent = `åˆ é™¤å·²é€‰ (${count})`;
            } else {
                hint.style.display = 'none';
                countLabel.textContent = '0';
                btn.disabled = true;
                btn.textContent = 'åˆ é™¤å·²é€‰';
            }
        }

        function syncSelectAllIndicator() {
            const selectAll = document.getElementById('selectAll');
            if (!state.filtered.length) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
                return;
            }

            const selectedOnScreen = state.filtered.filter(link => state.selection.has(link.slug)).length;

            if (selectedOnScreen === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (selectedOnScreen === state.filtered.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        function toggleSelectAll(checked) {
            if (checked) {
                state.filtered.forEach(link => state.selection.add(link.slug));
            } else {
                state.filtered.forEach(link => state.selection.delete(link.slug));
            }
            updateSelectionControls();
            renderTable();
        }

        function handleRowSelect(slug, checked) {
            if (!slug) return;
            if (checked) {
                state.selection.add(slug);
            } else {
                state.selection.delete(slug);
            }
            updateSelectionControls();
            syncSelectAllIndicator();
        }

        async function deleteSingle(slug) {
            if (!slug) return;
            if (!confirm(`ç¡®è®¤åˆ é™¤ /${slug} ?`)) return;
            await performDelete([slug]);
        }

        async function deleteSelected() {
            if (!state.selection.size) return;
            const slugs = Array.from(state.selection);
            if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${slugs.length} ä¸ªçŸ­é“¾å—ï¼Ÿ`)) return;
            await performDelete(slugs);
        }

        async function performDelete(slugs) {
            const key = localStorage.getItem('adminKey');
            if (!key) {
                logout();
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': key
                    },
                    body: JSON.stringify({ slugs })
                });

                if (res.status === 401) {
                    showToast('Admin Key æ— æ•ˆ', 'error');
                    setTimeout(logout, 1500);
                    return;
                }

                if (!res.ok) {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                    return;
                }

                showToast(`æˆåŠŸåˆ é™¤ ${slugs.length} ä¸ªçŸ­é“¾`);
                state.selection.clear();
                loadLinks();
            } catch (err) {
                showToast('é”™è¯¯: ' + err.message, 'error');
            }
        }

        function handleSearchInput(event) {
            state.query = event.target.value.trim().toLowerCase();
            document.getElementById('clearSearch').style.display = state.query ? 'block' : 'none';
            applyFilters();
        }

        function clearSearch() {
            state.query = '';
            const input = document.getElementById('searchInput');
            input.value = '';
            document.getElementById('clearSearch').style.display = 'none';
            input.focus();
            applyFilters();
        }

        function setFilter(filter) {
            state.filter = filter;
            document.querySelectorAll('#filterPills button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            applyFilters();
        }

        function setupControls() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', handleSearchInput);

            const pills = document.querySelectorAll('#filterPills button');
            pills.forEach(btn => {
                btn.addEventListener('click', () => setFilter(btn.dataset.filter));
            });

            const tbody = document.getElementById('linksBody');
            tbody.addEventListener('change', (event) => {
                if (event.target.matches('.row-checkbox')) {
                    handleRowSelect(event.target.dataset.slug, event.target.checked);
                }
            });
            tbody.addEventListener('click', (event) => {
                if (event.target.matches('.delete-link')) {
                    deleteSingle(event.target.dataset.slug);
                }
            });
        }

        setupControls();

        if (localStorage.getItem('adminKey')) {
            checkAuth();
        }
    </script>
</body>
</html>
